@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<h1 class="display-4">Explore your air quality</h1>
<div id="map" style="height: 600px; width: 100%; border-radius: 10px;"></div>

<script>
   
    async function getPollutionData(iso) {
      try {
        const response = await fetch(`/AirQuality/GetAQIByCities?iso=${iso}`);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        // Za svaki grad u povratnim podacima, dodaj krug na mapu
       data.forEach(city => {
         
          console.log(city);
          // Pretpostavljamo da ćeš imati neku mapu gradova i njihovih koordinata
         
            const circle = L.circle([city.latitude, city.longitude], {
              color: getColor(city.current.us_Aqi),  // Boja zavisno od AQI
              fillColor: getColor(city.current.us_Aqi),
              fillOpacity: 0.4,
              radius: 3000 // Poluprečnik kruga
            }).addTo(map);

            const aqiText = L.divIcon({
            className: 'aqi-text',  // Stilizovani CSS klasa
            html: `<div>${city.current.us_Aqi}</div>`,  // AQI broj
            iconSize: [20, 20]
          });

          // Kreiraj marker sa tekstom
          L.marker([city.latitude, city.longitude], { icon: aqiText }).addTo(map);

            // Dodaj pop-up sa imenom grada i AQI vrednošću
            //circle.bindPopup(`${city} - AQI: ${city.current.us_Aqi}`);
          
        });

      } catch (error) {
        console.error('Error fetching pollution data:', error);
      }
    }

    var map = L.map('map', {
      center: [43.8486, 18.3564],  // Koordinate Sarajeva (ili bilo kojeg grada na Balkanu)
      zoom: 9,                     // Početni nivo zoom-a
      minZoom: 9,                  // Minimalni nivo zoom-a (ne možeš da odzumiraš dalje)
      maxZoom: 9,                  // Maksimalni nivo zoom-a (ne možeš da zumiš dalje)
      scrollWheelZoom: false,      // Onemogući zoom sa točkom miša
      dragging: true,              // Omogućava pomeranje mape
      touchZoom: false,            // Onemogući zoom na mobilnim uređajima dodirom
      doubleClickZoom: false       // Onemogući zoom na dupli klik
    });

    // Dodaj tile layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var bounds = [
      [42.5, 15.5],  // Jugozapad
      [44.5, 19.7]   // Severoistok
    ];

    // Ograniči mapu da ne može izaći van Balkana
    map.setMaxBounds(bounds);

    // Uključi ovo da onemogući pomeranje izvan granica
    map.on('drag', function() {
      map.panInsideBounds(bounds);
    });

    // getPollutionData(sarajevo.lat, sarajevo.lon).then(pollutionData => {
    //   if (pollutionData) {
    //     const aqi = 30;//pollutionData.aqi;

    //     // Kreiraj krug sa dinamičkom bojom na temelju AQI vrijednosti
    //     L.circle([sarajevo.lat, sarajevo.lon], {
    //       color: getAqiColor(aqi),
    //       fillColor: getAqiColor(aqi),
    //       fillOpacity: 0.5,
    //       radius: 500
    //     }).addTo(map)
    //       .bindPopup(`<b>Sarajevo</b><br>AQI: ${aqi}`);
    //   } else {
    //     alert("Podaci o zagađenju nisu dostupni.");
    //   }
    // });

    function getColor(aqi) {
        if(0 < aqi && aqi <= 50) return 'green';
        if(aqi >= 51 && aqi <= 100) return 'yellow';
        if(aqi >= 101 && aqi <= 150) return 'orange';
        if(aqi >= 151 && aqi <= 200) return 'red';
        if(aqi >= 201 && aqi <= 300) return 'purple';
        return 'maroon';
    }

     getPollutionData('BA');
</script>



<style>
    .aqi-text {
        color: white;
        font-weight: bold;
        font-size: 12px;
        text-align: center;
        /* line-height: 20px; */ /* Vertikalno poravnavanje */
    }
</style>
@page 
@model FavouriteCitiesModel
@{
    ViewData["Title"] = "Favourite Cities";
}

<h6 class="display-4">Your favourite places</h6>
<div style="margin:50px 0;">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
        <i class="fas fa-plus"></i>  Add
    </button>
</div>

<div class="card shadow mb-4">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead id="favouritesThead">
                    <tr>
                        <th>City</th>
                        <th>Country</th>
                        <th>AQI(US)</th>
                        <th>PM2.5(µg/m³)</th>
                        <th>PM10(µg/m³)</th>
                        <th>Updated time</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="favouritesTbody">
                    @if (Model.Cities != null && Model.Cities.Any())
                    {
                        foreach (var f in Model.Cities)
                        {
                            <tr>
                                <td>@f.CityData.City</td>
                                <td>@f.CityData.Country</td>
                                <td>@f.CityData.AQI</td>
                                <td>@f.CityData.PM25</td>
                                <td>@f.CityData.PM10</td>
                                <td>@f.CityData.MeasuredAt</td>
                                <td>
                                    <button class="btn btn-sm btn-danger remove-favourite" type="button" data-fav-id="@f.Id">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <div class="popover-confirm d-none">
                                        <button class="btn btn-sm btn-danger confirm-delete">Confirm Delete</button>
                                        <button class="btn btn-sm btn-secondary cancel-delete">Cancel</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr id="noDataRow">
                            <td colspan="8" class="text-center text-muted">
                                <i class="fas fa-search" style="height:30px;"></i> You have no favourite cities yet.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="cityModal" class="modal">
    <div class="modal-content">
        <h3>Select City</h3>

        <input type="text" id="citySearch" placeholder="Search city..." />

        <div id="cityList" class="city-list w-100"></div>

        <div class="modal-buttons">
            <button id="cancelBtn">Cancel</button>
            <button id="okBtn">OK</button>
        </div>
    </div>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Add favourite city</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input id="city-search" type="text" class="form-control bg-light border-0 small" placeholder="Search for..."
                       aria-label="Search" aria-describedby="basic-addon2">
                <ul id="searchResults" class="list-group position-absolute mt-1 mw-100" style="z-index: 999; top:76%; max-height:240px; overflow-y:auto; width:94%;"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="saveCityBtn" type="button" class="btn btn-primary" disabled>Save changes</button>
            </div>
        </div>
    </div>
</div>
@section Scripts{
<script>
    $(document).ready(function () {
    (function () {
        const searchInput = document.getElementById("city-search");
        const resultsList = document.getElementById("searchResults");
        const saveBtn = document.getElementById("saveCityBtn");
        const tableBody = document.getElementById("favouritesTbody");
        const noDataRow = document.getElementById("noDataRow");
        const searchModal = document.getElementById("exampleModal");
        const favouritesThead= document.getElementById("favouritesThead");
        let selectedCity = null;

        let page = 1;
        const pageSize = 25;
        let isLoading = false;
        let hasMore = true;
        let currentTerm = "";

        let inputDebounce = null;

        const hasData = tableBody.rows.length > 1;
        if (!hasData) {
            favouritesThead.style.display = 'none';
        }
        else{
            favouritesThead.style.display = '';
        }

        function buildUrl(term, p) {
            const params = new URLSearchParams();
            if (term && term.length > 0) params.append("Name", term);
            params.append("Page", p);
            params.append("PageSize", pageSize);
            params.append("SkipFavourites", true);
            return `/api/City?${params.toString()}`;
        }

        async function loadCities(term, reset = false) {
            if (isLoading) return;
            if (reset) {
                page = 1;
                hasMore = true;
                resultsList.innerHTML = "";
                selectedCity = null;
                updateSaveButton();
            }
            if (!hasMore) return;

            isLoading = true;
            const url = buildUrl(term, page);

            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error("Failed to load cities");
                const items = await resp.json();

                if (!Array.isArray(items) || items.length < pageSize) {
                    hasMore = false;
                }
                resultsList.style.display = 'block';
                appendCities(items);
                page++;
            } catch (err) {
                console.error("Error loading cities:", err);
            } finally {
                isLoading = false;
            }
        }

        function appendCities(cities) {
            if (!cities || cities.length === 0) {
                if (resultsList.children.length === 0) {
                    const empty = document.createElement("div");
                    empty.className = "text-muted p-2";
                    empty.textContent = "No cities available";
                    resultsList.appendChild(empty);
                }
                saveBtn.disabled = true;
                hasMore = false;
                return;
            }

            cities.forEach(city => {
                const li = document.createElement("li");
                li.className = "list-group-item list-group-item-action";
                li.tabIndex = 0;
                li.style.cursor = "pointer";
                li.textContent = `${city.name}, ${city.country}`;

                li.addEventListener("click", () => {
                    selectCity(city, li);
                });

                li.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") selectCity(city, li);
                });

                resultsList.appendChild(li);
            });
        }

        function selectCity(city, element) {
            [...resultsList.children].forEach(ch => ch.classList.remove("active"));
            if (element) element.classList.add("active");
            selectedCity = city;
            searchInput.value = `${city.name}, ${city.country}`;
            resultsList.innerHTML = "";
            hasMore = false;
            updateSaveButton();
        }

        function updateSaveButton() {
            saveBtn.disabled = selectedCity === null;
        }

        // load next page
        resultsList.addEventListener("scroll", () => {
            if (isLoading || !hasMore) return;
            const threshold = 80; 
            if (resultsList.scrollTop + resultsList.clientHeight >= resultsList.scrollHeight - threshold) {
                loadCities(currentTerm, false);
            }
        });

        searchInput.addEventListener("input", function () {
            const term = this.value.trim();
            if (term.length < 1) {
                resultsList.innerHTML = "";
                return;
            }
           
            currentTerm = term;
            clearTimeout(inputDebounce);
            inputDebounce = setTimeout(() => {
                hasMore = true;
                loadCities(currentTerm, true);
            }, 300);
        });

        $('#exampleModal').on('show.bs.modal', function () {
            resultsList.style.display = 'none';
            currentTerm = "";
            page = 1;
            hasMore = true;
            resultsList.innerHTML = "";
            selectedCity = null;
            searchInput.value = "";
            updateSaveButton();
        });

        searchModal.addEventListener('click', function (event) {
            if (!resultsList.contains(event.target) && !resultsList.contains(event.target)) {
                resultsList.style.display = 'none';
            }
        });
        
        saveBtn.addEventListener("click", () => {
            if (!selectedCity) return;
            const payload = { cityId: selectedCity.id };
            fetch('/api/FavouriteCities?handler=Add', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
                .then(async(response) => {
                    if (!response.ok) {
                        throw new Error("Failed to save city");
                    }

                    await appendCityToTable(selectedCity.id);

                    $('#exampleModal').modal('hide');
                    return response;
                })
                .catch(error => {
                    console.error("Error:", error);
                });
            $('#exampleModal').modal('hide');
        });

         async function appendCityToTable(cityId) {
            const response = await fetch(`/api/FavouriteCities/GetFavouriteCities?cityId=${cityId}`);
            const data = await response.json();
            const item = data[0];

            const row = document.createElement("tr");
           
            row.innerHTML = `
                <td>${item.cityData.city}</td>
                <td>${item.cityData.country}</td>
                <td>${item.cityData.aqi}</td>
                <td>${item.cityData.pm25}</td>
                <td>${item.cityData.pm10}</td>
                <td>${item.cityData.measuredAt}</td>
                <td>
                    <button class="btn btn-sm btn-danger remove-favourite" type="button" data-fav-id="${item.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                    <div class="popover-confirm d-none">
                        <button class="btn btn-sm btn-danger confirm-delete">Confirm Delete</button>
                        <button class="btn btn-sm btn-secondary cancel-delete">Cancel</button>
                    </div>
                </td>
            `;

            tableBody.appendChild(row);

            // update header visibility
            const hasDataAfterAppend = tableBody.rows.length > 1;
            favouritesThead.style.display = hasDataAfterAppend ? '' : 'none';
        }

        // Use event delegation on the tbody so dynamically added rows work
        tableBody.addEventListener('click', async function (e) {
            const removeBtn = e.target.closest('.remove-favourite');
            if (removeBtn) {
                // hide any open popovers, then toggle this one
                document.querySelectorAll('.popover-confirm').forEach(popover => popover.classList.add('d-none'));
                const popover = removeBtn.nextElementSibling;
                if (popover) popover.classList.toggle('d-none');
                return;
            }

            const confirmBtn = e.target.closest('.confirm-delete');
            if (confirmBtn) {
                const cityId = confirmBtn.closest('td').querySelector('.remove-favourite').getAttribute('data-fav-id');
                try {
                    const resp = await fetch(`/api/FavouriteCities/${cityId}`, { method: 'POST' });
                    if (resp.ok) {
                        confirmBtn.closest('tr').remove();
                        console.log("City deleted successfully.");
                    } else {
                        alert("Failed to delete city.");
                    }
                } catch (error) {
                    alert("Error: " + error.message);
                }

                const pop = confirmBtn.closest('td').querySelector('.popover-confirm');
                if (pop) pop.classList.add('d-none');

                const hasDataAfterDelete = tableBody.rows.length > 1;
                favouritesThead.style.display = hasDataAfterDelete ? '' : 'none';
                return;
            }

            const cancelBtn = e.target.closest('.cancel-delete');
            if (cancelBtn) {
                const pop = cancelBtn.closest('.popover-confirm');
                if (pop) pop.classList.add('d-none');
            }
        });

    })();
});
</script>
}
<style>
    .popover-confirm {
        position: absolute;
        display: none;
        background-color: white;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        z-index: 10;
        width: auto;
        white-space: nowrap;
    }

    .remove-favourite {
        position: relative;
    }

        .remove-favourite:hover + .popover-confirm,
        .popover-confirm:hover {
            display: block;
        }

    .popover-confirm button {
        margin: 5px;
    }</style>
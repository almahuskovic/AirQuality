@page 
@model FavouriteCitiesModel
@{
}
<div id="server-rendered-debug" class="mb-3">
    Server rendered at @DateTime.Now
</div>

<h5 class="display-4">Your favourite places</h5>
<div style="margin:50px 0;">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
        <i class="fas fa-plus"></i>  Add
    </button>
</div>

<div class="card shadow mb-4">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>City</th>
                        <th>Country</th>
                        <th>AQI(US)</th>
                        <th>PM2.5(µg/m³)</th>
                        <th>PM10(µg/m³)</th>
                        <th>Updated time</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="favouritesTbody">
                    @if (Model.Cities != null && Model.Cities.Any())
                    {
                        foreach (var f in Model.Cities)
                        {
                            <tr>
                                <td>@f.City</td>
                                <td>@f.Country</td>
                                <td>@f.AQI</td>
                                <td>@f.PM25</td>
                                <td>@f.PM10</td>
                                <td>@f.MeasuredAt</td>
                                <td>
                                    <button class="btn btn-sm btn-danger remove-favourite" type="button" data-fav-id="@( (f.GetType().GetProperty("Id") != null) ? ((dynamic)f).Id : 0 )">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center text-muted">You have no favourite cities yet.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="cityModal" class="modal">
    <div class="modal-content">
        <h3>Select City</h3>

        <input type="text" id="citySearch" placeholder="Search city..." />

        <div id="cityList" class="city-list w-100"></div>

        <div class="modal-buttons">
            <button id="cancelBtn">Cancel</button>
            <button id="okBtn">OK</button>
        </div>
    </div>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input id="city-search" type="text" class="form-control bg-light border-0 small" placeholder="Search for..."
                       aria-label="Search" aria-describedby="basic-addon2">
                <ul id="searchResults" class="list-group position-absolute mt-1 mw-100" style="z-index: 999; top:100%; max-height:240px; overflow-y:auto;"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="saveCityBtn" type="button" class="btn btn-primary" disabled>Save changes</button>
            </div>
        </div>
    </div>
</div>
@section Scripts{
<script>
    $(document).ready(function () {
      //your code here
   
    // Pagination + incremental loading + server-side search + selection enabling Save
    (function () {
        const searchInput = document.getElementById("city-search");
        const resultsList = document.getElementById("searchResults");
        const saveBtn = document.getElementById("saveCityBtn");
        const favouritesTbody = document.getElementById("favouritesTbody");
        let selectedCity = null;

        // paging state
        let page = 1;
        const pageSize = 25;
        let isLoading = false;
        let hasMore = true;
        let currentTerm = "";

        // debounce timer for typing
        let inputDebounce = null;

        // utility to build query string - backend expects Name, Page, PageSize
        function buildUrl(term, p) {
            const params = new URLSearchParams();
            if (term && term.length > 0) params.append("Name", term);
            params.append("Page", p);
            params.append("PageSize", pageSize);
            return `/City?${params.toString()}`;
        }

        async function loadCities(term, reset = false) {
            if (isLoading) return;
            if (reset) {
                page = 1;
                hasMore = true;
                resultsList.innerHTML = "";
                selectedCity = null;
                updateSaveButton();
            }
            if (!hasMore) return;

            isLoading = true;
            const url = buildUrl(term, page);

            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error("Failed to load cities");
                const items = await resp.json();

                // if fewer items than pageSize -> no more pages
                if (!Array.isArray(items) || items.length < pageSize) {
                    hasMore = false;
                }

                appendCities(items);
                page++;
            } catch (err) {
                console.error("Error loading cities:", err);
            } finally {
                isLoading = false;
            }
        }

        function appendCities(cities) {
            if (!cities || cities.length === 0) {
                if (resultsList.children.length === 0) {
                         const empty = document.createElement("div");
                    empty.className = "text-muted p-2";
                    empty.textContent = "No cities available";
                    resultsList.appendChild(empty);
                }
                    saveBtn.disabled = true;
            hasMore = false;
                return;
            }

            cities.forEach(city => {
                const li = document.createElement("li");
                li.className = "list-group-item list-group-item-action";
                li.tabIndex = 0;
                li.style.cursor = "pointer";
                li.textContent = `${city.name}, ${city.country}`;

                li.addEventListener("click", () => {
                    selectCity(city, li);
                });

                li.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") selectCity(city, li);
                });

                resultsList.appendChild(li);
            });
        }

        function selectCity(city, element) {
            // clear previous active
            [...resultsList.children].forEach(ch => ch.classList.remove("active"));
            if (element) element.classList.add("active");
            selectedCity = city;
            searchInput.value = `${city.name}, ${city.country}`;
            // collapse results to avoid accidental further scrolls
            // keep the list visible if you want a visual confirmation
            // clear results to make selection obvious
            resultsList.innerHTML = "";
            // set hasMore false temporarily so further scroll doesn't fetch
            hasMore = false;
            updateSaveButton();
        }

        function updateSaveButton() {
            saveBtn.disabled = selectedCity === null;
        }

        // scroll: when user scrolls near bottom, load next page
        resultsList.addEventListener("scroll", () => {
            if (isLoading || !hasMore) return;
            const threshold = 80; // px from bottom
            if (resultsList.scrollTop + resultsList.clientHeight >= resultsList.scrollHeight - threshold) {
                loadCities(currentTerm, false);
            }
        });

        // typing: server-side accurate search. debounce to avoid too many calls.
        searchInput.addEventListener("input", function () {
            const term = this.value.trim();
            currentTerm = term;
            clearTimeout(inputDebounce);
            // when user types, reset paging and fetch from server (accurate results)
            inputDebounce = setTimeout(() => {
                // if empty search, still fetch first page (useful to show popular / first page)
                hasMore = true;
                loadCities(currentTerm, true);
            }, 300);
        });

        // open modal handler: when modal opens, reset and load first page
        $('#exampleModal').on('show.bs.modal', function () {
            currentTerm = "";
            page = 1;
            hasMore = true;
            resultsList.innerHTML = "";
            selectedCity = null;
            searchInput.value = "";
            updateSaveButton();
            loadCities("", true);
        });

        // Save action: only enabled when a city is selected
        saveBtn.addEventListener("click", () => {
            if (!selectedCity) return;
            // perform saving logic here (e.g., POST to favourites endpoint)
            // Example:
            console.log(selectCity);
            const payload={ cityId: selectedCity.id };
                fetch('/api/FavouriteCities?handler=Add', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
                    .then(response => {
                        if (!response.ok) {
                            // Ako odgovor nije OK, bacit ćemo grešku
                            throw new Error("Failed to save city");
                        }

                        appendCityToTable(selectedCity);

                        // Zatvori modal
                        $('#exampleModal').modal('hide');
                        return response;  // Ovdje se samo vraća 'response', bez automatskog parsiranja
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });

            console.log("Selected city to save:", selectedCity);
            // close modal for UX
            $('#exampleModal').modal('hide');
        });

        function appendCityToTable(city) {
            const tableBody = document.querySelector("#favouritesTbody");

            // Kreiraj novi red u tabeli
            const row = document.createElement("tr");

            // Popuni red sa podacima grada
            row.innerHTML = `
                <td>${city.name}</td>
                <td>${city.country}</td>
                <td>${city.country}</td>
                <td>${city.country}</td>
                <td>${city.country}</td>
                <td>${city.country}</td>
               
                <td>
                    <button class="btn btn-sm btn-danger remove-favourite" type="button" data-fav-id="${city.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            // Dodaj red u tabelu
            tableBody.appendChild(row);
        }
        // initial load if modal not used: optionally pre-load first page
        // loadCities("", true);
    })();
});
</script>}